# Astrobot v2

Personal AI assistant with OpenRouter backend, Telegram interface, and specialist agent orchestration.

## Features

- **OpenRouter Backend** — Use any LLM model via OpenRouter's unified API. Per-agent model configuration.
- **Telegram DM Interface** — Direct message your bot for all interactions. Clean, simple.
- **Orchestrator + Specialists** — Master agent routes tasks to specialist agents, each with their own model and tools.
- **PostgreSQL + pgvector Memory** — Long-term vector-searchable memory per agent. Conversations persist until cleared.
- **MCP Tool System** — All tools provided via Model Context Protocol servers. Extensible at runtime.
- **1Password Credentials** — Secrets managed via 1Password CLI. No `.env` files on production.
- **Docker Containers** — Each agent runs in an isolated Docker container with IPC communication.
- **Conversation System** — Orchestrator maintains conversation context for 8 hours. `/clear` to reset.

## Architecture

```
Telegram DM
    ↓
Host Orchestrator (Node.js)
    ↓
Docker Container: Orchestrator Agent (8hr TTL)
    ├── MCP: IPC (send_message, delegate, ask_user)
    ├── MCP: Memory (remember, recall, clear)
    └── MCP: External servers (configurable)
    ↓
Docker Container: Specialist Agent
    ├── MCP: IPC
    ├── MCP: Memory (isolated per-agent)
    └── MCP: Agent-specific servers
    ↓
Result → Orchestrator → Telegram
```

## Quick Start

### Prerequisites

- Node.js 20+
- Docker
- [1Password CLI](https://developer.1password.com/docs/cli/get-started/) (`op`)
- Telegram Bot Token (from [@BotFather](https://t.me/BotFather))
- OpenRouter API Key (from [openrouter.ai](https://openrouter.ai))

### Deploy (VPS or any server)

The deploy script handles everything: 1Password vault creation, credential storage, bot customization, model selection, container builds, and service startup.

```bash
git clone <your-fork-url>
cd astrobot
./scripts/deploy.sh
```

The script will walk you through:
1. **System checks** — Docker, Node.js, 1Password CLI
2. **1Password setup** — Creates a `Astrobot` vault, stores all secrets
3. **Bot customization** — Name your assistant, pick orchestrator and specialist models
4. **Build & launch** — Builds containers, starts PostgreSQL + Astrobot

### Update

Pull latest changes, rebuild, and restart with zero-downtime:

```bash
./scripts/update.sh
```

Flags:
- `--reconfigure` — Change models, name, or rotate credentials
- `--no-git` — Skip git pull
- `--no-build` — Skip container rebuild
- `--force` — Skip confirmation prompts

### Development Setup

```bash
npm install
docker compose up -d postgres
cp .env.example .env   # Fill in your values
./container/build.sh
npm run dev
```

## Configuration

All configuration lives in `.env` (generated by `deploy.sh`). Secrets are stored in 1Password and resolved at deploy/update time.

| Variable | Description | Default |
|----------|-------------|---------|
| `TELEGRAM_BOT_TOKEN` | Telegram bot token | required |
| `OPENROUTER_API_KEY` | OpenRouter API key | required |
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://astrobot:...@postgres:5432/astrobot` |
| `ASSISTANT_NAME` | Bot display name | `Nano` |
| `ORCHESTRATOR_MODEL` | Model for orchestrator agent | `anthropic/claude-sonnet-4-20250514` |
| `DEFAULT_AGENT_MODEL` | Default model for specialists | `anthropic/claude-sonnet-4-20250514` |
| `EMBEDDING_MODEL` | Model for vector embeddings | `openai/text-embedding-3-small` |
| `ORCHESTRATOR_TTL` | Orchestrator container lifetime (ms) | `28800000` (8hr) |
| `IDLE_TIMEOUT` | Container idle timeout (ms) | `1800000` (30min) |
| `MAX_CONCURRENT_CONTAINERS` | Max parallel agent containers | `5` |

### Credential Management

Secrets are managed via 1Password:
- **Deploy**: `deploy.sh` creates a `Astrobot` vault with items for Telegram, OpenRouter, and PostgreSQL
- **Rotate**: `./scripts/update.sh --reconfigure` to update any credential
- **1Password vault**: All secrets live in the `Astrobot` vault — manage them in the 1Password app or CLI

## Commands

| Command | Description |
|---------|-------------|
| `/start` | Initialize the bot |
| `/clear` | Clear conversation, summarize to memory, start fresh |

## Specialist Agents

Specialist agents are dynamic — the orchestrator creates and manages them at your direction. Just tell it:

> "Create a coding agent" → it asks you which model → creates the agent

> "Update the research agent to use GPT-4o" → updates the model

> "Delete the writing agent" → removes it and its memories

**You always choose the model.** The orchestrator will never pick a model on its own.

You can also add agents directly via SQL:

```sql
INSERT INTO agents (name, system_prompt, model)
VALUES (
  'coder',
  'You are a coding specialist. You write clean, well-tested code.',
  'deepseek/deepseek-chat'
);
```

## Adding MCP Servers

MCP servers can be registered in the `mcp_servers` table:

```sql
INSERT INTO mcp_servers (name, transport, command, args, scope)
VALUES (
  'filesystem',
  'stdio',
  'npx',
  '["@modelcontextprotocol/server-filesystem", "/workspace"]',
  'global'
);
```

Global servers are available to all agents. Agent-specific servers are configured in the agent's `mcp_servers` JSON field.

## License

MIT
